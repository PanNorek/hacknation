# Override file for local development
# Copy this to docker-compose.override.yml and modify as needed

version: "3.8"

services:
  app:
    # Mount source code for development
    volumes:
      - .:/app
    # Override environment for development
    environment:
      - DB_POSTGRES_HOST=postgres
      - DB_POSTGRES_PORT=5432
      - DB_POSTGRES_DB=${POSTGRES_DB:-hack}
      - DB_POSTGRES_USER=${POSTGRES_USER:-hack}
      - DB_POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-hack}
    # Use development command
    command: >
      sh -c "
        echo 'Waiting for postgres to be ready...' &&
        while ! nc -z postgres 5432; do sleep 1; done &&
        echo 'Running database migrations...' &&
        uv run alembic upgrade head &&
        echo 'Creating embeddings...' &&
        uv run python create_embeddings.py &&
        echo 'Starting API in development mode...' &&
        uv run uvicorn src.api:app --reload --host 0.0.0.0 --port 8000 --log-level info
      "

  postgres:
    # Expose port for local development
    ports:
      - "5432:5432"
